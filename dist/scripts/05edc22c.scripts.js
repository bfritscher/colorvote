"use strict";function padLeft(a,b){for(a=a.toString();a.length<b;)a="0"+a;return a}var app={},CONFIG={clientId:"192909161969.apps.googleusercontent.com",scopes:["https://www.googleapis.com/auth/userinfo.email"]};app.module=angular.module("colorvoteApp",["ngRoute","uuid4","LocalStorageModule"]),app.module.value("config",CONFIG),app.loadRoomQuestion=function(a,b){var c=a.current.params.room;return"admin"===a.current.originalPath.split("/").pop()&&(c+="-admin"),b.join(c)},app.loadRoomQuestion.$inject=["$route","model"],app.loadAdmin=function(a){return a.requireAuth(!0).then(function(){return a.authorize()})},app.loadAdmin.$inject=["model"],app.module.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:room",{templateUrl:"views/voter.html",controller:"VoterCtrl",resolve:{question:app.loadRoomQuestion}}).when("/:room/admin",{templateUrl:"views/asker.html",controller:"AskerCtrl",resolve:{question:app.loadRoomQuestion,user:app.loadAdmin}}).otherwise({redirectTo:"/"})}]),app.module.run(["$rootScope","$location",function(a,b){a.$on("$routeChangeError",function(){b.path("/")})}]),gapi.load("auth:client",function(){gapi.auth.init(),angular.element(document).ready(function(){angular.bootstrap(document,["colorvoteApp"])})}),angular.module("colorvoteApp").controller("MainCtrl",["$scope","$window","$location","model",function(a,b,c,d){a.data=d.data,d.data.question={},d.getRooms(),a.addRoom=function(){var c=b.prompt("Room name?");c&&a.rooms.push({name:c})},a.renameRoom=function(a){var c=b.prompt("Room name?",a.name);c&&c.length>0&&c!==a.name&&(a.name=c)},a.go=function(b){a.$root.loading=!0,a.data.admin&&(b+="/admin"),c.path(b)},a.$root.loading=!1}]),angular.module("colorvoteApp").controller("VoterCtrl",["$scope","$location","model","$window","$routeParams",function(a,b,c,d,e){ga("send","pageview",b.path());var f=e.room;a.data=c.data,a.choices=[0,1,2,3,4,5,6,7],a.showCardVote=!1,a.toggleCardVote=function(){var c=b.path();a.showCardVote||(c+="/cards"),ga("send","pageview",c),a.showCardVote=!a.showCardVote},a.setVote=function(b){a.data.question.vote=b,c.vote()},a.go=function(a){b.path(a)},a.$on("$destroy",function(){c.leave(f)}),d.onbeforeunload=function(){c.leave(f)},a.$root.loading=!1}]),angular.module("colorvoteApp").controller("AskerCtrl",["$scope","$location","$interval","model","$window","$routeParams",function(a,b,c,d,e,f){function g(a){var b;b="stopped"===a.state?moment(a.dateStopped).diff(a.dateStarted):moment().diff(a.dateStarted),b=Math.round(b/1e3);var c=b%60;return padLeft((b-c)/60,2)+":"+padLeft(c,2)}ga("send","pageview",b.path());var h=f.room;a.href=b.absUrl().replace("/admin","").replace("/#/","/#"),a.data=d.data,a.model=d,a.votes=function(){return a.data.question.results?a.data.question.results.reduce(function(a,b){return a+b}):0};var i=function(){a.elapsedTime=g(a.data.question)};i(),c(i,1e3),a.$watch("data.question.possibleAnswers",function(){a.data.question.results=a.data.question.results.slice(0,a.data.question.possibleAnswers);for(var b=0;b<a.data.question.possibleAnswers-a.data.question.results.length;b++)a.data.question.results.push(0)}),a.questionAction=function(){a.showresults="stopped"===d.data.question.state?!1:!0,d.questionAction()},a.toggleHistory=function(){a.showhistory||d.getHistory(),a.showhistory=!a.showhistory},a.formatTime=function(a){return g(a)},a.formatDate=function(a){return moment(a.dateStopped).format("DD.MM.YYYY HH:mm")},a.$on("$destroy",function(){d.leave(h)}),e.onbeforeunload=function(){d.leave(h)},a.go=function(a){b.path(a)},a.$root.loading=!1}]),angular.module("colorvoteApp").directive("qrcode",function(){return{template:'<div class="qrcode"></div>',restrict:"E",replace:!0,scope:{href:"=href",width:"=width",height:"=height"},link:function(a,b){a.$watch("[href, width, height]",function(){new QRCode(b[0],{width:a.width||400,height:a.height||400,text:a.href||"empty"})},!0)}}}),angular.module("colorvoteApp").directive("chart",function(){return{template:'<svg width="500" height="500" class="chart"><g class="transform"><g class="x axis"></g><g class="y axis"></g></g></svg>',replace:!0,restrict:"E",scope:{data:"=data"},link:function(a,b){a.$watch("data",function(){var c={top:30,right:20,bottom:30,left:40},d=500-c.left-c.right,e=500-c.top-c.bottom,f=d3.format(".0%"),g=d3.scale.ordinal().rangeRoundBands([0,d],.1),h=d3.scale.linear().range([e,0]),i=a.data,j=d3.keys(i).sort(),k=d3.svg.axis().scale(g).orient("bottom"),l=d3.sum(d3.values(i)),m=d3.svg.axis().scale(h).tickFormat(d3.format("d")).tickSubdivide(0).orient("left"),n=d3.select(b[0]).attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).select("g.transform").attr("transform","translate("+c.left+","+c.top+")");g.domain(j),h.domain([0,d3.max(d3.values(i))]),n.select("g.x.axis").attr("transform","translate(0,"+e+")").call(k),n.select("g.y.axis").transition().duration(1e3).call(m);var o=n.selectAll(".bar").data(d3.entries(i)),p=o.enter(),q=p.append("g").attr("class","bar").attr("transform",function(a){return"translate("+g(a.key)+",0)"});q.append("rect").attr("class",function(a){return"color-"+a.key}).attr("width",g.rangeBand()).attr("y",function(a){return h(a.value)}).attr("height",function(a){return e-h(a.value)}),q.append("text").attr("x",g.rangeBand()/2-12).attr("y",function(a){return h(a.value)-8}),o.attr("transform",function(a){return"translate("+g(a.key)+",0)"}),o.select("rect").transition().duration(1e3).attr("y",function(a){return h(a.value)}).attr("height",function(a){return e-h(a.value)}),o.select("rect").attr("width",g.rangeBand()),o.select("text").transition().duration(1e3).text(function(a){return f(a.value/l||0)}).attr("y",function(a){return h(a.value)-8}),o.select("text").attr("x",g.rangeBand()/2-12),o.exit().remove()},!0)}}}),angular.module("colorvoteApp").directive("voteswiper",function(){return{restrict:"A",link:function(a){var b=new Swiper(".swiper-container.voter",{pagination:".pagination",paginationClickable:!0,createPagination:!0,loop:!0,watchActiveIndex:!0,queueEndCallbacks:!0,onSlideChangeEnd:function(b){a.$apply(function(){a.setVote(b.activeLoopIndex)})}});a.$watch("[data.question.possibleAnswers, data.question.vote, choices]",function(){for(var c,d=a.data.question.possibleAnswers,e=d+2-b.slides.length,f=0;e>f;f++)b.createSlide('<div class="title"></div>').append();for(f=0;d+2>f;f++)if(c=b.getSlide(f),c&&d>0){var g=f;g=g===d+1?0:0===g?d-1:f-1,c.className="swiper-slide color-"+g,c.querySelector(".title").textContent=a.choices[g]}for(;d+2<b.slides.length;)c=b.getSlide(d+2),c&&(c.isActive()&&b.swipeTo(0,0),c.remove());b.activeLoopIndex!==a.data.question.vote&&a.data.question.vote<d&&b.swipeTo(a.data.question.vote,0)},!0)}}}).directive("historyswiper",function(){return function(a){var b;a.$watch("$last",function(a){a&&(b&&b.destroy(),b=new Swiper(".history .swiper-container",{pagination:".pagination",paginationClickable:!0,centeredSlides:!0,slidesPerView:"auto",loop:!1,watchActiveIndex:!0,initialSlide:0,onFirstInit:function(){}}))})}}),angular.module("colorvoteApp").service("model",["$q","$rootScope","$timeout","uuid4","localStorageService","config",function(a,b,c,d,e,f){var g=this,h=[],i=e.get("userId");null===i&&(i=d.generate(),e.add("userId",i)),this.data={connectedCount:0,user:{_id:i,admin:!1}};var j=Primus.connect("ws://colorvote.ch"),k={q:"question",r:"rooms",c:"connectedCount"};j.on("open",function(){j.on("data",function(a){a=a||{};var c=k[a.o]||a.o,d=a.p,e=a.v;void 0===g.data[c]&&(g.data[c]={}),e&&(void 0!==d&&"object"==typeof g.data[c]?g.data[c][d]=e:g.data[c]=e),b.$digest(),h.forEach(function(a){a.updated(c)})}),g.data.question&&g.data.question.room&&g.join(g.data.question.room),g.data.online=!0}),j.on("reconnecting",function(){b.$apply(function(){g.data.online=!1})}),this.getRooms=function(){j.write({a:"getRooms"})},this.vote=function(){j.write({a:"v",u:g.data.user._id,q:g.data.question._id,v:g.data.question.vote})},this.join=function(b){var d=a.defer();return d.updated=function(a){"question"===a&&(h.splice(h.indexOf(d),1),d.resolve(g.data.question))},c(function(){d.reject("timeout")},1e4),h.push(d),j.write({a:"join",v:b,u:g.data.user._id}),d.promise},this.leave=function(a){j.write({a:"leave",v:a})},this.getHistory=function(){j.write({a:"history",v:g.data.question.roomId})},this.questionAction=function(){j.write({a:"questionAction",v:g.data.question._id,u:g.data.user._id,t:g.data.user.access_token})},this.possibleAnswers=function(){j.write({a:"possibleAnswers",q:g.data.question._id,v:g.data.question.possibleAnswers,u:g.data.user._id,t:g.data.user.access_token})},this.addAdmin=function(a){j.write({a:"addAdmin",v:a,u:g.data.user._id,t:g.data.user.access_token})},this.authorize=function(){var b=a.defer();return gapi.client.load("oauth2","v2",function(){var a=gapi.client.oauth2.userinfo.get();a.execute(function(a){j.write({a:"login",t:gapi.auth.getToken().access_token,u:a.id}),e.add("userId",a.id)})}),b.updated=function(a){"user"===a&&(h.splice(h.indexOf(b),1),g.data.user.admin?b.resolve(g.data.user):(console.log("Rejected userlogin with id:"+g.data.user._id),b.reject()))},c(function(){b.reject("timeout")},1e4),h.push(b),b.promise},this.requireAuth=function(c){var d=gapi.auth.getToken(),e=Date.now()/1e3;if(d&&d.expires_at-e>60)return a.when(d);var g={client_id:f.clientId,scope:f.scopes,immediate:c},h=a.defer(),i=function j(){gapi.auth.authorize(g,function(a){a&&!a.error?h.resolve(a):g.immediate?(g.immediate=!1,j()):h.reject(a),b.$digest()})};return i(),h.promise}}]);